<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <script src="https://unpkg.com/mammoth@1.4.21/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108,117,125,0.3);
        }

        .file-input {
            display: none;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .editor-panel {
            padding: 30px;
            border-right: 1px solid #dee2e6;
            background: #fafafa;
            overflow-y: auto;
            max-height: 700px;
        }

        .preview-panel {
            padding: 30px;
            background: white;
            overflow-y: auto;
            max-height: 700px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .format-toolbar {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 10px 15px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .format-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .format-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .document-content {
            line-height: 1.6;
            font-size: 14px;
            color: #333;
        }

        .editable-field {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: text;
            transition: all 0.3s ease;
            min-width: 100px;
            display: inline-block;
        }

        .editable-field:hover {
            background: #ffeaa7;
            border-color: #fdcb6e;
            transform: scale(1.02);
        }

        .editable-field:focus {
            outline: none;
            background: white;
            border: 2px solid #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .field-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .field-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-editor {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 12px;
            border-radius: 6px;
            min-height: 50px;
            cursor: text;
            font-size: 14px;
            line-height: 1.4;
            width: 100%;
        }

        .field-editor:focus {
            outline: none;
            background: white;
            border: 2px solid #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .field-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .field-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .field-btn:hover {
            background: #f8f9fa;
        }

        .field-btn.danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .field-btn.danger:hover {
            background: #c82333;
        }

        .status {
            padding: 15px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù –û–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç .docx –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∂–µ–ª—Ç—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>

        <div class="toolbar">
            <input type="file" id="fileInput" class="file-input" accept=".docx" />
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å .docx —Ñ–∞–π–ª
            </button>
            <button class="btn btn-success" onclick="downloadDocument()" id="downloadBtn" disabled>
                üíæ –°–∫–∞—á–∞—Ç—å .docx
            </button>
            <button class="btn btn-secondary" onclick="loadTemplate()">
                üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <button class="btn btn-secondary" onclick="showManualFieldCreator()">
                ‚úèÔ∏è –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é
            </button>
        </div>

        <div class="status" id="status"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...
        </div>

        <div class="editor-container">
            <div class="editor-panel">
                <div class="panel-title">
                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ–ª–µ–π
                </div>
                <div class="format-toolbar">
                    <button class="format-btn" onclick="formatField('bold')" title="–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç">
                        <strong>B</strong>
                    </button>
                    <button class="format-btn" onclick="formatField('italic')" title="–ö—É—Ä—Å–∏–≤">
                        <em>I</em>
                    </button>
                    <button class="format-btn" onclick="formatField('underline')" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π">
                        <u>U</u>
                    </button>
                    <button class="format-btn" onclick="changeFieldColor()" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç">
                        üé®
                    </button>
                    <button class="format-btn" onclick="clearFormatting()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                        üßπ
                    </button>
                </div>
                <div id="fieldsContainer">
                    <div class="empty-state">
                        <p>üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π</p>
                        <p style="margin-top: 10px; font-size: 12px;">–ñ–µ–ª—Ç—ã–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏</p>
                    </div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="panel-title">
                    üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                </div>
                <div id="preview" class="document-content">
                    <div class="empty-state">
                        <p>üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                        <p style="margin-top: 10px; font-size: 12px;">–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let documentData = null;
        let editableFields = [];
        let currentField = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.docx')) {
                loadDocument(file);
            } else {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .docx', 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function loadDocument(file) {
            showLoading(true);
            showStatus('');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer});
                
                documentData = {
                    html: result.value,
                    originalHtml: result.value
                };

                processDocument();
                showStatus(`–î–æ–∫—É–º–µ–Ω—Ç "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!`, 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞
        function loadTemplate() {
            const templateHtml = `
                <div style="font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">AGREEMENT ‚Ññ <span style="background: yellow; padding: 2px 6px;">25.09.04</span></h2>
                    <p style="text-align: right; margin-bottom: 30px;">–î–∞—Ç–∞: <span style="background: yellow; padding: 2px 6px;">04 September 2025</span></p>
                    
                    <p style="margin-bottom: 20px;"><strong><span style="background: yellow; padding: 2px 6px;">Mindtrix LLC</span></strong>, hereinafter referred to as the "Customer" on the one hand and <strong>Time Quest Lab LLC</strong>, hereinafter referred to as the "Executor" on the other hand, together referred to as the "Parties", have finalized the present Agreement, as follows:</p>
                    
                    <h3 style="margin: 30px 0 15px 0;">1. SUBJECT OF AGREEMENT</h3>
                    <p style="margin-bottom: 15px;">1.1. Under this Agreement the Executor undertakes to perform the following works by the Customer's task:</p>
                    <ul style="margin-left: 20px; margin-bottom: 20px;">
                        <li style="margin-bottom: 8px;"><span style="background: yellow; padding: 2px 6px;">Prepare equipment for escape room</span></li>
                        <li style="margin-bottom: 8px;"><span style="background: yellow; padding: 2px 6px;">Prepare decoration for escape room</span></li>
                        <li style="margin-bottom: 8px;"><span style="background: yellow; padding: 2px 6px;">Prepare separate modules according to the Specification</span></li>
                    </ul>
                    
                    <h3 style="margin: 30px 0 15px 0;">2. TERMS</h3>
                    <p style="margin-bottom: 15px;">2.1.1. The deadline for the work is <span style="background: yellow; padding: 2px 6px;">90 calendar days</span> from the date the Executor receives the advance payment.</p>
                    
                    <h3 style="margin: 30px 0 15px 0;">3. PRICE OF WORK AND PAYMENT</h3>
                    <p style="margin-bottom: 15px;">3.1. The total Agreement price is <span style="background: yellow; padding: 2px 6px;">10,000 (ten thousand) US dollars</span>.</p>
                    <p style="margin-bottom: 15px;">3.2. Payment is made by the Customer <span style="background: yellow; padding: 2px 6px;">in the amount of 100% of the Contract value within</span> 3 working days from the date of notification.</p>
                    
                    <h3 style="margin: 30px 0 15px 0;">10. ADDRESSES, DETAILS AND SIGNATURES OF THE PARTIES</h3>
                    <div style="margin: 20px 0;">
                        <p style="margin-bottom: 10px;"><strong>Customer:</strong></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">Mindtrix LLC</span></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">4155 Mapleton Drive</span></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">West Linn, OR 97068</span></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">+1 (229) 563-4204</span></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">mike@mindtrixescape.com</span></p>
                        <p style="margin-bottom: 5px;"><span style="background: yellow; padding: 2px 6px;">Mike Walker</span></p>
                    </div>
                </div>
            `;

            documentData = {
                html: templateHtml,
                originalHtml: templateHtml
            };

            processDocument();
            showStatus('–®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function processDocument() {
            if (!documentData) return;

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = documentData.html;

            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –∂–µ–ª—Ç–æ–≥–æ —Ñ–æ–Ω–∞
            const yellowSelectors = [
                '[style*="background:yellow"]',
                '[style*="background: yellow"]', 
                '[style*="background-color:yellow"]',
                '[style*="background-color: yellow"]',
                '[style*="background: #ffff00"]',
                '[style*="background:#ffff00"]',
                '[style*="background-color: #ffff00"]',
                '[style*="background-color:#ffff00"]',
                '[style*="highlight"]',
                '[class*="highlight"]',
                '[class*="yellow"]',
                '.highlight',
                '.yellow'
            ];

            let yellowElements = [];
            yellowSelectors.forEach(selector => {
                try {
                    const elements = tempDiv.querySelectorAll(selector);
                    yellowElements = yellowElements.concat(Array.from(elements));
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
                }
            });

            // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
            yellowElements = [...new Set(yellowElements)];

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∂–µ–ª—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
            if (yellowElements.length === 0) {
                yellowElements = findHighlightedText(tempDiv);
            }

            // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            if (yellowElements.length === 0) {
                showHighlightInstructions(tempDiv);
                return;
            }
            
            editableFields = [];
            yellowElements.forEach((element, index) => {
                const fieldId = `field_${index}`;
                const originalText = element.textContent.trim();
                
                if (originalText.length === 0) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                
                // –°–æ–∑–¥–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
                const editableSpan = document.createElement('span');
                editableSpan.id = fieldId;
                editableSpan.className = 'editable-field';
                editableSpan.contentEditable = true;
                editableSpan.textContent = originalText;
                editableSpan.setAttribute('data-original', originalText);
                editableSpan.style.backgroundColor = '#ffc107';
                editableSpan.style.padding = '2px 6px';
                editableSpan.style.borderRadius = '3px';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                editableSpan.addEventListener('input', () => updatePreview());
                editableSpan.addEventListener('focus', () => setCurrentField(fieldId));
                editableSpan.addEventListener('blur', () => clearCurrentField());
                
                // –ó–∞–º–µ–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                element.parentNode.replaceChild(editableSpan, element);
                
                editableFields.push({
                    id: fieldId,
                    element: editableSpan,
                    originalText: originalText
                });
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º HTML
            documentData.html = tempDiv.innerHTML;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
            displayFields();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
            updatePreview();
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            document.getElementById('downloadBtn').disabled = false;
        }

        // –ü–æ–∏—Å–∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É (–µ—Å–ª–∏ —Å—Ç–∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç)
        function findHighlightedText(container) {
            const elements = container.querySelectorAll('*');
            const highlightedElements = [];
            
            elements.forEach(element => {
                const text = element.textContent.trim();
                
                // –ò—â–µ–º —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∑–∞–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–æ–ª—è
                if (text && (
                    text.match(/^\d{2}\.\d{2}\.\d{2}$/) || // –¥–∞—Ç—ã —Ç–∏–ø–∞ 25.09.04
                    text.match(/^\d+ calendar days$/) || // —Å—Ä–æ–∫–∏
                    text.match(/^\d+,?\d*\s*\([^)]+\)\s*US dollars?$/) || // —Å—É–º–º—ã
                    text.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+$/) || // –∏–º–µ–Ω–∞
                    text.match(/^\+?\d+[\s\-\(\)\d]+$/) || // —Ç–µ–ª–µ—Ñ–æ–Ω—ã
                    text.match(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/) || // email
                    text.match(/^\d+\s+[A-Za-z]+\s+[A-Za-z]+/) || // –∞–¥—Ä–µ—Å–∞
                    text.length > 3 && text.length < 50 && 
                    (text.includes('LLC') || text.includes('Company') || text.includes('Ltd'))
                )) {
                    highlightedElements.push(element);
                }
            });
            
            return highlightedElements;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤—ã–¥–µ–ª–µ–Ω–∏—é
        function showHighlightInstructions(container) {
            const containerDiv = document.getElementById('fieldsContainer');
            containerDiv.innerHTML = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è –ñ–µ–ª—Ç—ã–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                    <p style="margin-bottom: 10px; color: #856404;">–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ç–µ–∫—Å—Ç–∞ —Å –∂–µ–ª—Ç—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º.</p>
                    <p style="margin-bottom: 15px; color: #856404;">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                    <ul style="margin-left: 20px; color: #856404; margin-bottom: 15px;">
                        <li>–í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ</li>
                        <li>–§–æ—Ä–º–∞—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π</li>
                        <li>–î–æ–∫—É–º–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                    </ul>
                    <p style="margin-bottom: 15px; color: #856404;"><strong>–†–µ—à–µ–Ω–∏—è:</strong></p>
                    <ul style="margin-left: 20px; color: #856404; margin-bottom: 15px;">
                        <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã–¥–µ–ª–µ–Ω –∂–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º</li>
                        <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω" –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                        <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ Word —Å —è–≤–Ω—ã–º –∂–µ–ª—Ç—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º</li>
                    </ul>
                    <button onclick="loadTemplate()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω
                    </button>
                </div>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π HTML –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            document.getElementById('preview').innerHTML = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                    <h4 style="color: #495057; margin-bottom: 15px;">üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞:</h4>
                    <pre style="background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; overflow-x: auto; font-size: 12px; color: #333;">${container.innerHTML}</pre>
                </div>
            `;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        function displayFields() {
            const container = document.getElementById('fieldsContainer');
            container.innerHTML = '';

            if (editableFields.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∂–µ–ª—Ç—ã—Ö –≤—ã–¥–µ–ª–µ–Ω–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p></div>';
                return;
            }

            editableFields.forEach((field, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field-item';
                
                fieldDiv.innerHTML = `
                    <div class="field-label">–ü–æ–ª–µ ${index + 1}</div>
                    <div id="${field.id}_display" class="field-editor" contenteditable="true">
                        ${field.originalText}
                    </div>
                    <div class="field-actions">
                        <button class="field-btn" onclick="resetField('${field.id}')">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        <button class="field-btn danger" onclick="deleteField('${field.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;

                const displayElement = fieldDiv.querySelector(`#${field.id}_display`);
                displayElement.addEventListener('input', () => {
                    field.element.textContent = displayElement.textContent;
                    updatePreview();
                });
                displayElement.addEventListener('focus', () => setCurrentField(field.id));

                container.appendChild(fieldDiv);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function updatePreview() {
            if (!documentData) return;

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = documentData.html;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ª–µ–π
            editableFields.forEach(field => {
                const element = tempDiv.querySelector(`#${field.id}`);
                if (element) {
                    element.textContent = field.element.textContent;
                }
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π HTML
            document.getElementById('preview').innerHTML = tempDiv.innerHTML;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—è
        function setCurrentField(fieldId) {
            currentField = fieldId;
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ
            editableFields.forEach(field => {
                field.element.style.boxShadow = field.id === fieldId ? '0 0 0 3px rgba(0,123,255,0.3)' : '';
            });
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—è
        function clearCurrentField() {
            currentField = null;
            editableFields.forEach(field => {
                field.element.style.boxShadow = '';
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è
        function formatField(format) {
            if (!currentField) return;

            const field = editableFields.find(f => f.id === currentField);
            if (!field) return;

            document.execCommand(format);
            updatePreview();
        }

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø–æ–ª—è
        function changeFieldColor() {
            if (!currentField) return;

            const colors = ['#ffc107', '#28a745', '#dc3545', '#17a2b8', '#6f42c1'];
            const currentColor = editableFields.find(f => f.id === currentField)?.element.style.backgroundColor || '#ffc107';
            const currentIndex = colors.indexOf(currentColor);
            const nextColor = colors[(currentIndex + 1) % colors.length];

            const field = editableFields.find(f => f.id === currentField);
            if (field) {
                field.element.style.backgroundColor = nextColor;
                updatePreview();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function clearFormatting() {
            if (!currentField) return;

            document.execCommand('removeFormat');
            updatePreview();
        }

        // –°–±—Ä–æ—Å –ø–æ–ª—è
        function resetField(fieldId) {
            const field = editableFields.find(f => f.id === fieldId);
            if (field) {
                field.element.textContent = field.originalText;
                updatePreview();
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è
        function deleteField(fieldId) {
            const fieldIndex = editableFields.findIndex(f => f.id === fieldId);
            if (fieldIndex !== -1) {
                editableFields.splice(fieldIndex, 1);
                displayFields();
                updatePreview();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ
        function clearAll() {
            documentData = null;
            editableFields = [];
            currentField = null;
            document.getElementById('fieldsContainer').innerHTML = '<div class="empty-state"><p>üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π</p></div>';
            document.getElementById('preview').innerHTML = '<div class="empty-state"><p>üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p></div>';
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('fileInput').value = '';
            showStatus('');
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function downloadDocument() {
            if (!documentData) return;

            showLoading(true);
            try {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = document.getElementById('preview').innerHTML;

                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const editableElements = tempDiv.querySelectorAll('.editable-field');
                editableElements.forEach(element => {
                    element.className = '';
                    element.contentEditable = false;
                    element.style.backgroundColor = '#ffc107';
                });

                const finalHtml = tempDiv.innerHTML;

                // –°–æ–∑–¥–∞–µ–º HTML —Ñ–∞–π–ª
                const blob = new Blob([`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</title>
                        <style>
                            body { 
                                font-family: 'Times New Roman', serif; 
                                margin: 40px; 
                                line-height: 1.6;
                                max-width: 800px;
                                margin: 40px auto;
                            }
                            .highlighted { 
                                background-color: #ffc107; 
                                padding: 2px 6px;
                                border-radius: 3px;
                            }
                            h1, h2, h3 { color: #333; }
                            p { margin-bottom: 15px; }
                        </style>
                    </head>
                    <body>
                        ${finalHtml}
                    </body>
                    </html>
                `], { type: 'text/html' });

                saveAs(blob, 'edited_document.html');
                showStatus('–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω –∫–∞–∫ HTML!', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
            } finally {
                showLoading(false);
            }
        }

        // –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π
        function showManualFieldCreator() {
            const container = document.getElementById('fieldsContainer');
            container.innerHTML = `
                <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;">‚úèÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–µ–π –≤—Ä—É—á–Ω—É—é</h4>
                    <p style="margin-bottom: 15px; color: #1976d2;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º –ø–æ–ª–µ–º:</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #1976d2; font-weight: 500;">–¢–µ–∫—Å—Ç –ø–æ–ª—è:</label>
                        <input type="text" id="fieldText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—è" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #1976d2; font-weight: 500;">–ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ:</label>
                        <input type="text" id="searchText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="createManualField()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ
                        </button>
                        <button onclick="searchInDocument()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            üîç –ù–∞–π—Ç–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
                        </button>
                        <button onclick="displayFields()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                    
                    <div id="searchResults" style="margin-top: 15px;"></div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é
        function createManualField() {
            const fieldText = document.getElementById('fieldText').value.trim();
            if (!fieldText) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—è', 'error');
                return;
            }

            const fieldId = `manual_field_${Date.now()}`;
            const editableSpan = document.createElement('span');
            editableSpan.id = fieldId;
            editableSpan.className = 'editable-field';
            editableSpan.contentEditable = true;
            editableSpan.textContent = fieldText;
            editableSpan.setAttribute('data-original', fieldText);
            editableSpan.style.backgroundColor = '#ffc107';
            editableSpan.style.padding = '2px 6px';
            editableSpan.style.borderRadius = '3px';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            editableSpan.addEventListener('input', () => updatePreview());
            editableSpan.addEventListener('focus', () => setCurrentField(fieldId));
            editableSpan.addEventListener('blur', () => clearCurrentField());
            
            editableFields.push({
                id: fieldId,
                element: editableSpan,
                originalText: fieldText
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
            updatePreview();
            displayFields();
            showStatus(`–ü–æ–ª–µ "${fieldText}" —Å–æ–∑–¥–∞–Ω–æ!`, 'success');
        }

        // –ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
        function searchInDocument() {
            const searchText = document.getElementById('searchText').value.trim();
            if (!searchText) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
                return;
            }

            const previewDiv = document.getElementById('preview');
            const html = previewDiv.innerHTML;
            
            if (html.includes(searchText)) {
                const highlightedHtml = html.replace(
                    new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
                    `<span style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">${searchText}</span>`
                );
                previewDiv.innerHTML = highlightedHtml;
                
                document.getElementById('searchResults').innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 10px; color: #155724;">
                        ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ! –¢–µ–∫—Å—Ç –≤—ã–¥–µ–ª–µ–Ω –∂–µ–ª—Ç—ã–º –≤ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ.
                    </div>
                `;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ —Ç–µ–∫—Å—Ç–∞
                document.getElementById('fieldText').value = searchText;
            } else {
                document.getElementById('searchResults').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; color: #721c24;">
                        ‚ùå –¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ.
                    </div>
                `;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = message ? 'block' : 'none';
            
            if (message && type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
