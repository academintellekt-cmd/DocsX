<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–≤–æ–π—Å–æ–≤ - Time Quest Lab</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- docx.js –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DOCX —Ñ–∞–π–ª–æ–≤ -->
    
    <!-- FileSaver.js –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- DOCX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="navigation">
            <a href="index.html">üìã –î–æ–≥–æ–≤–æ—Ä—ã</a>
            <a href="invoice.html" class="active">üßæ –ò–Ω–≤–æ–π—Å—ã</a>
        </nav>

        <div class="header">
            <h1>üßæ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–≤–æ–π—Å–æ–≤</h1>
            <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã –¥–ª—è Time Quest Lab LLC</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2>üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–∞</h2>
                <form id="contractForm">
                    <!-- –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∏–Ω–≤–æ–π—Å–µ -->
                    <div class="form-group">
                        <label for="agreementNumber">–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞:</label>
                        <input type="text" id="agreementNumber" name="agreementNumber" required>
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ -->
                    <input type="hidden" id="agreementDate" name="agreementDate">
                    <input type="hidden" id="customerName" name="customerName">
                    <input type="hidden" id="customerAddress" name="customerAddress">
                    <input type="hidden" id="customerCity" name="customerCity">
                    <input type="hidden" id="customerPhone" name="customerPhone">
                    <input type="hidden" id="customerEmail" name="customerEmail">
                    <input type="hidden" id="customerSignatory" name="customerSignatory">
                    <input type="hidden" id="contractPrice" name="contractPrice">
                    <input type="hidden" id="currency" name="currency">
                    <input type="hidden" id="paymentTerms" name="paymentTerms">
                    <input type="hidden" id="workDescription" name="workDescription">
                    <input type="hidden" id="deadlineDays" name="deadlineDays">

                    <!-- –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∏–Ω–≤–æ–π—Å–µ -->
                    <div class="form-section">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–≤–æ–π—Å–∞</h3>
                        
                        <div class="form-group">
                            <label for="termOfDelivery">–£—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏ (Term of delivery):</label>
                            <input type="text" id="termOfDelivery" name="termOfDelivery" value="CIP SFO" required>
                            <small style="color: #666; font-size: 12px;">–ù–∞–ø—Ä–∏–º–µ—Ä: CIP SFO, FOB, CIF –∏ —Ç.–¥.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="signatureImage">–ü–æ–¥–ø–∏—Å—å (PNG):</label>
                        <input type="file" id="signatureImage" name="signatureImage" accept=".png" onchange="loadSignatureFile()">
                        <small style="color: #666; font-size: 12px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG</small>
                        <button type="button" onclick="clearSignatureCache()" style="margin-top: 5px; padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                        <div id="signaturePreview" style="margin-top: 10px; display: none;">
                            <img id="signatureImg" style="height: 70px; width: auto; border: 1px solid #ccc;">
                        </div>
                        
                        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã —Ä–∞–∑–º–µ—Ä–∞ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ -->
                        <div id="signatureControls" style="margin-top: 10px; display: none;">
                            <label style="font-size: 14px; font-weight: bold;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∏:</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <label style="font-size: 12px;">–®–∏—Ä–∏–Ω–∞ (px):</label>
                                    <input type="number" id="signatureWidth" value="200" min="50" max="500" step="10" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" onchange="updateSignatureSize()" oninput="updateSignatureSize()">
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <label style="font-size: 12px;">–í—ã—Å–æ—Ç–∞ (px):</label>
                                    <input type="number" id="signatureHeight" value="100" min="30" max="300" step="10" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" onchange="updateSignatureSize()" oninput="updateSignatureSize()">
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <label style="font-size: 12px;">–í–≤–µ—Ä—Ö/–í–Ω–∏–∑ (px):</label>
                                    <input type="number" id="signatureOffsetY" value="0" min="-100" max="100" step="10" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" onchange="updateSignatureSize()" oninput="updateSignatureSize()">
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <label style="font-size: 12px;">–í–ª–µ–≤–æ/–í–ø—Ä–∞–≤–æ (px):</label>
                                    <input type="number" id="signatureOffsetX" value="0" min="-100" max="100" step="10" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" onchange="updateSignatureSize()" oninput="updateSignatureSize()">
                                </div>
                                
                                <button type="button" onclick="resetSignatureSize()" style="padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">–°–±—Ä–æ—Å</button>
                            </div>
                        </div>
                    </div>

                    
                    <button type="button" class="btn download-btn" onclick="downloadInvoiceNew()">üíæ –°–∫–∞—á–∞—Ç—å –∏–Ω–≤–æ–π—Å (DOCX)</button>
                    <button type="button" class="btn download-btn" onclick="downloadInvoiceHTML()">üìÑ –°–∫–∞—á–∞—Ç—å –∏–Ω–≤–æ–π—Å (HTML)</button>
                    <button type="button" class="btn" onclick="generateInvoice()" style="background: #28a745; color: white; margin-top: 10px;">üîÑ –¢–µ—Å—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</button>
                </form>
            </div>
            
            <div class="preview-section">
                <h2>üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
                <div id="contractPreview" class="invoice-preview">
                    <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–æ–π—Å–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
    <script src="shared.js"></script>
    
    <script>

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–∏ (–ª–æ–∫–∞–ª—å–Ω–∞—è)
        function loadSignatureFile() {
            const fileInput = document.getElementById('signatureImage');
            const file = fileInput.files[0];
            const preview = document.getElementById('signaturePreview');
            
            if (file) {
                if (file.type === 'image/png') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Data = e.target.result;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å
                        window.loadedSignature = base64Data;
                        saveSignature(base64Data);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                        preview.style.display = 'block';
                        preview.innerHTML = `<img id="signatureImg" src="${base64Data}" style="height: 70px; width: auto; border: 1px solid #ccc;">`;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                        applySignatureSize();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã —Ä–∞–∑–º–µ—Ä–∞
                        const controls = document.getElementById('signatureControls');
                        if (controls) {
                            controls.style.display = 'block';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å
                        generateInvoice();
                        saveAllData();
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG');
                    fileInput.value = '';
                }
            } else {
                // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            }
        }

        function updateSignatureSize() {
            console.log('üîÑ updateSignatureSize called');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ —Å–º–µ—â–µ–Ω–∏—è
            const width = document.getElementById('signatureWidth').value;
            const height = document.getElementById('signatureHeight').value;
            const offsetY = document.getElementById('signatureOffsetY').value;
            const offsetX = document.getElementById('signatureOffsetX').value;
            console.log('üìè New dimensions:', width, 'x', height, 'offsetY:', offsetY, 'offsetX:', offsetX);
            
            localStorage.setItem('signatureWidth', width);
            localStorage.setItem('signatureHeight', height);
            localStorage.setItem('signatureOffsetY', offsetY);
            localStorage.setItem('signatureOffsetX', offsetX);
            
            // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –ø–æ–¥–ø–∏—Å–∏ —Å–ª–µ–≤–∞ - —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞
            console.log('‚úÖ Settings saved, updating document preview only');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å
            generateInvoice();
        }

        function applySignatureSize() {
            console.log('üîß applySignatureSize called');
            
            const width = localStorage.getItem('signatureWidth') || '200';
            const height = localStorage.getItem('signatureHeight') || '100';
            const offsetY = localStorage.getItem('signatureOffsetY') || '0';
            const offsetX = localStorage.getItem('signatureOffsetX') || '0';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
            const widthInput = document.getElementById('signatureWidth');
            const heightInput = document.getElementById('signatureHeight');
            const offsetYInput = document.getElementById('signatureOffsetY');
            const offsetXInput = document.getElementById('signatureOffsetX');
            if (widthInput) widthInput.value = width;
            if (heightInput) heightInput.value = height;
            if (offsetYInput) offsetYInput.value = offsetY;
            if (offsetXInput) offsetXInput.value = offsetX;
            
            // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø—Ä–µ–≤—å—é —Å–ª–µ–≤–∞ - —Ç–æ–ª—å–∫–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —Å–ø—Ä–∞–≤–∞
            console.log('‚úÖ Applied size to input fields only');
        }

        function resetSignatureSize() {
            console.log('üîÑ resetSignatureSize called');
            
            localStorage.removeItem('signatureWidth');
            localStorage.removeItem('signatureHeight');
            localStorage.removeItem('signatureOffsetY');
            localStorage.removeItem('signatureOffsetX');
            
            const widthInput = document.getElementById('signatureWidth');
            const heightInput = document.getElementById('signatureHeight');
            const offsetYInput = document.getElementById('signatureOffsetY');
            const offsetXInput = document.getElementById('signatureOffsetX');
            if (widthInput) widthInput.value = '200';
            if (heightInput) heightInput.value = '100';
            if (offsetYInput) offsetYInput.value = '0';
            if (offsetXInput) offsetXInput.value = '0';
            
            // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –ø–æ–¥–ø–∏—Å–∏ —Å–ª–µ–≤–∞ - —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞
            console.log('‚úÖ Settings reset to defaults');
            
            generateInvoice();
        }

        function generateInvoice() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            const previewElement = document.getElementById('contractPreview');
            if (!previewElement) {
                console.error('‚ùå contractPreview element not found!');
                return;
            }
            
            const data = getFormData();

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            const formattedDate = formatAgreementDate(data.agreementDate);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Ñ–∞–∫—Ç—É—Ä—ã —Å–æ–≥–ª–∞—Å–Ω–æ —à–∞–±–ª–æ–Ω—É
            const invoiceHTML = `
                <p style="text-align: center; font-weight: bold; margin-bottom: 20px;">
                    INVOICE ‚Ññ <span class="highlight">${data.agreementNumber}</span>
                </p>

                <p style="text-align: center; margin-bottom: 20px;">
                    <span class="highlight">"${new Date(data.agreementDate).getDate()}" ${new Date(data.agreementDate).toLocaleDateString('en-GB', {month: 'long'})} ${new Date(data.agreementDate).getFullYear()}</span>
                </p>

                <p><strong>SENT BY</strong></p>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Company Name (Beneficiary):</td>
                        <td style="border: 1px solid #000; padding: 8px;">Time Quest Lab LLC</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Address:</td>
                        <td style="border: 1px solid #000; padding: 8px;">Armenia, Yerevan, 9 May str., 51/ 27</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">City/Zip Code:</td>
                        <td style="border: 1px solid #000; padding: 8px;">Yerevan, 0026</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Country:</td>
                        <td style="border: 1px solid #000; padding: 8px;">Armenia</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">phone number:</td>
                        <td style="border: 1px solid #000; padding: 8px;">+374 98171651</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Tax ID:</td>
                        <td style="border: 1px solid #000; padding: 8px;">1702302685</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Bank name:</td>
                        <td style="border: 1px solid #000; padding: 8px;">ARDSHINBANK</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">SWIFT code:</td>
                        <td style="border: 1px solid #000; padding: 8px;">ASHBAM22</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Bank address:</td>
                        <td style="border: 1px solid #000; padding: 8px;">Yerevan, Grigor Lusavorich 13</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Account Number:</td>
                        <td style="border: 1px solid #000; padding: 8px;">2474402605340010</td>
                    </tr>
                </table>

                <p><strong>SENT TO</strong></p>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Company Name:</td>
                        <td style="border: 1px solid #000; padding: 8px;"><span class="highlight">${data.customerName}</span></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Address:</td>
                        <td style="border: 1px solid #000; padding: 8px;"><span class="highlight">${data.customerAddress}</span></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">City/Country:</td>
                        <td style="border: 1px solid #000; padding: 8px;"><span class="highlight">${data.customerCity}</span></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Tel.:</td>
                        <td style="border: 1px solid #000; padding: 8px;"><span class="highlight">${data.customerPhone}</span></td>
                    </tr>
                </table>

                <p><strong>PAYMENT DETAILS</strong></p>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Currency of invoice:</td>
                        <td style="border: 1px solid #000; padding: 8px;">${data.currency === 'EUR' ? 'Euro' : 'US dollar'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Purpose of payment/Number of contract:</td>
                        <td style="border: 1px solid #000; padding: 8px;">No.${data.agreementNumber} from ${new Date(data.agreementDate).getDate()} ${new Date(data.agreementDate).toLocaleDateString('en-GB', {month: 'long'})} ${new Date(data.agreementDate).getFullYear()}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Amount:</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                            <span class="highlight">${formatNumber(parseInt(data.contractPrice) || 0)} (${numberToWords(parseInt(data.contractPrice) || 0)})</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Country of origin</td>
                        <td style="border: 1px solid #000; padding: 8px;">Russia</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">HS code</td>
                        <td style="border: 1px solid #000; padding: 8px;">9508290000</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Term of delivery</td>
                        <td style="border: 1px solid #000; padding: 8px;"><span class="highlight">${data.termOfDelivery || 'CIP SFO'}</span></td>
                    </tr>
                </table>

                <p style="font-style: italic; margin: 15px 0;">
                    * - commission of foreign banks intermediaries are paid by the Customer
                </p>

                <p style="margin: 20px 0;">
                    I declare that the above information is true and correct to the best of my knowledge.
                </p>

                <div style="margin-top: 30px;">
                    <p style="position: relative;">
                        Signature: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
                        ${window.loadedSignature ? 
                            `<img src="${window.loadedSignature}" class="signature-overlay" style="width: ${safeParseInt(localStorage.getItem('signatureWidth'), 200, 50, 500)}px; height: ${safeParseInt(localStorage.getItem('signatureHeight'), 150, 30, 300)}px; top: ${safeParseInt(localStorage.getItem('signatureOffsetY'), 0, -100, 100)}px; left: ${safeParseInt(localStorage.getItem('signatureOffsetX'), 0, -100, 100)}px;" />` : 
                            '<!-- NO SIGNATURE -->'
                        }
                    </p>
                </div>
            `;

            previewElement.innerHTML = invoiceHTML;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML —Ñ–∞–π–ª–∞ –∏–Ω–≤–æ–π—Å–∞
        function downloadInvoiceHTML() {
            try {
                const data = getFormData();

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                const formattedDate = formatAgreementDate(data.agreementDate);

                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–Ω–≤–æ–π—Å–∞
                const invoiceContent = document.getElementById('contractPreview').innerHTML;

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π HTML –¥–æ–∫—É–º–µ–Ω—Ç
                const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${data.agreementNumber}</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            font-size: 11px;
            line-height: 1.3;
            margin: 20px;
        }
        .highlight { 
            background-color: transparent; 
            color: #000000;
        }
        .signature-overlay {
            position: absolute;
            top: -20px;
            left: 0;
            opacity: 0.8;
            pointer-events: none;
            z-index: 10;
            mix-blend-mode: multiply;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table td {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: top;
        }
    </style>
</head>
<body>
    ${invoiceContent}
</body>
</html>`;

                // –°–æ–∑–¥–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
                const blob = new Blob([fullHTML], { type: 'text/html; charset=utf-8' });
                const fileName = `Invoice_${data.agreementNumber}_${data.customerName.replace(/[^a-zA-Z0-9]/g, '_')}_${data.contractPrice}$${data.currency}.html`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å saveAs
                if (typeof saveAs === 'undefined') {
                    throw new Error('FileSaver.js library not loaded');
                }
                saveAs(blob, fileName);
                
            } catch (error) {
                console.error('HTML creation error:', error);
                alert('HTML creation failed: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DOCX
        async function downloadInvoiceNew() {
            const data = getFormData();

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            const formattedDate = formatAgreementDate(data.agreementDate);

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–ø–∏—Å–∏
                if (!window.loadedSignature) {
                    throw new Error('Signature not loaded. Please load a signature first.');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏
                console.log('üîç Signature format check:', {
                    hasSignature: !!window.loadedSignature,
                    isBase64: window.loadedSignature.includes(','),
                    length: window.loadedSignature.length,
                    signatureWidth: localStorage.getItem('signatureWidth'),
                    signatureHeight: localStorage.getItem('signatureHeight'),
                    signatureOffsetY: localStorage.getItem('signatureOffsetY'),
                    signatureOffsetX: localStorage.getItem('signatureOffsetX')
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º base64 –¥–∞–Ω–Ω—ã–µ
                let signatureData;
                if (window.loadedSignature && window.loadedSignature.includes(',')) {
                    signatureData = window.loadedSignature.split(',')[1];
                    console.log('üîç Base64 data length:', signatureData.length);
                    console.log('üîç Base64 data preview:', signatureData.substring(0, 50) + '...');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π base64
                    if (!signatureData || signatureData.length === 0) {
                        console.error('‚ùå Empty base64 data');
                        throw new Error('Empty signature data');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ base64 —Å–∏–º–≤–æ–ª—ã
                    const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                    if (!base64Regex.test(signatureData)) {
                        console.error('‚ùå Invalid base64 characters');
                        throw new Error('Invalid base64 signature data');
                    }
                } else {
                    console.error('‚ùå Invalid signature format - no base64 data found');
                    throw new Error('Invalid signature format');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å docx –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                if (typeof docx === 'undefined') {
                    console.error('DOCX library not loaded, attempting to load...');
                    await loadDocxLibrary();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    if (typeof docx === 'undefined') {
                        throw new Error('Failed to load docx library');
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º DOCX –¥–æ–∫—É–º–µ–Ω—Ç
                const { Document, Packer, Paragraph, HeadingLevel, AlignmentType, Table, TableRow, TableCell, WidthType, PageBreak, TextRun, BorderStyle, ImageRun, VerticalAlign } = docx;

                // –°–æ–∑–¥–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                const price = parseInt(data.contractPrice) || 0;
                const fileName = `Invoice_${data.agreementNumber}_${data.customerName.replace(/[^a-zA-Z0-9]/g, '_')}_$${price}_${data.currency}.docx`;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                text: `INVOICE ‚Ññ ${data.agreementNumber}`,
                                alignment: AlignmentType.CENTER,
                                heading: HeadingLevel.TITLE,
                            }),
                            new Paragraph({
                                text: `"${new Date(data.agreementDate).getDate()}" ${new Date(data.agreementDate).toLocaleDateString('en-GB', {month: 'long'})} ${new Date(data.agreementDate).getFullYear()}`,
                                alignment: AlignmentType.CENTER,
                            }),
                            new Paragraph({
                                text: "",
                            }),
                            new Paragraph({
                                text: "SENT BY",
                            }),
                            new Table({
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Company Name (Beneficiary):")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Time Quest Lab LLC")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Address:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Armenia, Yerevan, 9 May str., 51/ 27")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("City/Zip Code:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Yerevan, 0026")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Country:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Armenia")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("phone number:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("+374 98171651")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Tax ID:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("1702302685")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Bank name:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("ARDSHINBANK")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("SWIFT code:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("ASHBAM22")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Bank address:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Yerevan, Grigor Lusavorich 13")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Account Number:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("2474402605340010")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                ],
                                width: { size: 100, type: WidthType.PERCENTAGE },
                            }),
                            new Paragraph({
                                text: "",
                            }),
                            new Paragraph({
                                text: "SENT TO",
                            }),
                            new Table({
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Company Name:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.customerName)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Address:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.customerAddress)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("City/Country:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.customerCity)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Tel.:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.customerPhone)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                ],
                                width: { size: 100, type: WidthType.PERCENTAGE },
                            }),
                            new Paragraph({
                                text: "",
                            }),
                            new Paragraph({
                                text: "PAYMENT DETAILS",
                            }),
                            new Table({
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Currency of invoice:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.currency === 'EUR' ? 'Euro' : 'US dollar')],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Purpose of payment/Number of contract:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(`No.${data.agreementNumber} from ${new Date(data.agreementDate).getDate()} ${new Date(data.agreementDate).toLocaleDateString('en-GB', {month: 'long'})} ${new Date(data.agreementDate).getFullYear()}`)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Amount:")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(`${formatNumber(parseInt(data.contractPrice) || 0)} (${numberToWords(parseInt(data.contractPrice) || 0)})`)],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Country of origin")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("Russia")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("HS code")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph("9508290000")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                children: [new Paragraph("Term of delivery")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                            new TableCell({
                                                children: [new Paragraph(data.termOfDelivery || "CIP SFO")],
                                                borders: { top: { style: BorderStyle.SINGLE }, bottom: { style: BorderStyle.SINGLE }, left: { style: BorderStyle.SINGLE }, right: { style: BorderStyle.SINGLE } },
                                            }),
                                        ],
                                    }),
                                ],
                                width: { size: 100, type: WidthType.PERCENTAGE },
                            }),
                            new Paragraph({
                                text: "* - commission of foreign banks intermediaries are paid by the Customer",
                                italics: true,
                            }),
                            new Paragraph({
                                text: "",
                            }),
                            new Paragraph({
                                text: "I declare that the above information is true and correct to the best of my knowledge.",
                            }),
                            new Paragraph({
                                text: "",
                            }),
                            ...(window.loadedSignature ? [
                                new Table({
                                    rows: [
                                        new TableRow({
                                            children: [
                                                new TableCell({
                                                    verticalAlign: VerticalAlign.TOP,
                                                    children: [
                                                        new Paragraph({
                                                            alignment: AlignmentType.LEFT,
                                                            spacing: {
                                                                before: safeParseInt(localStorage.getItem('signatureOffsetY'), 0, -100, 100) * 20, // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ twips
                                                                after: 0,
                                                                left: safeParseInt(localStorage.getItem('signatureOffsetX'), 0, -100, 100) * 20, // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ twips
                                                                right: 0,
                                                            },
                                                            children: [
                                                                new TextRun({
                                                                    text: "Signature: ",
                                                                }),
                                                                new ImageRun({
                                                                    data: signatureData,
                                                                    transformation: {
                                                                        width: safeParseInt(localStorage.getItem('signatureWidth'), 200, 50, 500),
                                                                        height: safeParseInt(localStorage.getItem('signatureHeight'), 150, 30, 300),
                                                                    }
                                                                })
                                                            ],
                                                        })
                                                    ],
                                                    borders: {
                                                        top: { style: BorderStyle.NONE },
                                                        bottom: { style: BorderStyle.NONE },
                                                        left: { style: BorderStyle.NONE },
                                                        right: { style: BorderStyle.NONE },
                                                    },
                                                })
                                            ]
                                        })
                                    ],
                                    width: { size: 100, type: WidthType.PERCENTAGE },
                                    borders: {
                                        top: { style: BorderStyle.NONE },
                                        bottom: { style: BorderStyle.NONE },
                                        left: { style: BorderStyle.NONE },
                                        right: { style: BorderStyle.NONE },
                                        insideHorizontal: { style: BorderStyle.NONE },
                                        insideVertical: { style: BorderStyle.NONE },
                                    },
                                })
                            ] : [
                                new Paragraph({
                                    text: "Signature: ",
                                })
                            ]),
                        ],
                    }],
                });

                const blob = await Packer.toBlob(doc);
                
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                if (typeof saveAs === 'undefined') {
                    throw new Error('FileSaver.js library not loaded');
                }
                saveAs(blob, fileName);
                
            } catch (error) {
                console.error('DOCX creation error:', error);
                alert('DOCX creation failed: ' + error.message + '\n\nFalling back to HTML download...');
                
                // Fallback –∫ HTML
                downloadInvoiceHTML();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ DOCX –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–∏—Å–µ–ª –∏–∑ localStorage
        function safeParseInt(value, defaultValue, min = -Infinity, max = Infinity) {
            const parsed = parseInt(value);
            if (isNaN(parsed)) return defaultValue;
            return Math.max(min, Math.min(max, parsed));
        }

        async function loadDocxLibrary() {
            return new Promise((resolve, reject) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ —É–∂–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
                if (typeof docx !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js';
                script.onload = () => {
                    console.log('‚úÖ DOCX library loaded successfully');
                    resolve();
                };
                script.onerror = () => {
                    console.error('‚ùå Failed to load DOCX library from cdnjs, trying alternative...');
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    const altScript = document.createElement('script');
                    altScript.src = 'https://unpkg.com/docx@7.8.2/build/index.js';
                    altScript.onload = () => {
                        console.log('‚úÖ DOCX library loaded from alternative source');
                        resolve();
                    };
                    altScript.onerror = () => {
                        console.error('‚ùå Failed to load DOCX library from both sources');
                        reject(new Error('Failed to load DOCX library'));
                    };
                    document.head.appendChild(altScript);
                };
                document.head.appendChild(script);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            initializeForm();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            await restoreAllData();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω–≤–æ–π—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            setTimeout(() => {
                generateInvoice();
            }, 300);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã
        document.getElementById('agreementDate').addEventListener('change', function() {
            const contractNumber = generateContractNumber(this.value);
            document.getElementById('agreementNumber').value = contractNumber;
            generateInvoice();
            saveAllData();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã –∏ –≤–∞–ª—é—Ç—ã
        document.getElementById('contractPrice').addEventListener('input', function() {
            generateInvoice();
            saveAllData();
        });
        
        document.getElementById('currency').addEventListener('change', function() {
            generateInvoice();
            saveAllData();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è
        document.getElementById('contractForm').addEventListener('input', function() {
            generateInvoice();
            saveAllData();
        });

        // –û—Å–æ–±–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è Term of delivery
        document.getElementById('termOfDelivery').addEventListener('input', function() {
            generateInvoice();
            saveAllData();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ –∏–Ω–≤–æ–π—Å–∞
        document.getElementById('agreementNumber').addEventListener('input', function() {
            generateInvoice();
            saveAllData();
        });
    </script>
</body>
</html>

